<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="路由调用逻辑
gin 对外宣传的高效，很大一部分是说其路由效率。本文内容包括：
 路由API介绍 路由调用实现逻辑 路由的内部实现  路由API #  设置路由 #  // routergroup.go:20 type IRoutes interface { Use(handlers ...HandlerFunc) IRoutes Handle(httpMethod, relativePath string, handlers ...HandlerFunc) IRoutes Any(relativePath string, handlers ...HandlerFunc) IRoutes GET(relativePath string, handlers ...HandlerFunc) IRoutes POST(relativePath string, handlers ...HandlerFunc) IRoutes DELETE(relativePath string, handlers ...HandlerFunc) IRoutes PATCH(relativePath string, handlers ...HandlerFunc) IRoutes PUT(relativePath string, handlers ...HandlerFunc) IRoutes OPTIONS(relativePath string, handlers ...HandlerFunc) IRoutes HEAD(relativePath string, handlers ...HandlerFunc) IRoutes StaticFile(relativePath, filepath string) IRoutes Static(relativePath, root string) IRoutes StaticFS(relativePath string, fs http.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="" />
<meta property="og:description" content="路由调用逻辑
gin 对外宣传的高效，很大一部分是说其路由效率。本文内容包括：
 路由API介绍 路由调用实现逻辑 路由的内部实现  路由API #  设置路由 #  // routergroup.go:20 type IRoutes interface { Use(handlers ...HandlerFunc) IRoutes Handle(httpMethod, relativePath string, handlers ...HandlerFunc) IRoutes Any(relativePath string, handlers ...HandlerFunc) IRoutes GET(relativePath string, handlers ...HandlerFunc) IRoutes POST(relativePath string, handlers ...HandlerFunc) IRoutes DELETE(relativePath string, handlers ...HandlerFunc) IRoutes PATCH(relativePath string, handlers ...HandlerFunc) IRoutes PUT(relativePath string, handlers ...HandlerFunc) IRoutes OPTIONS(relativePath string, handlers ...HandlerFunc) IRoutes HEAD(relativePath string, handlers ...HandlerFunc) IRoutes StaticFile(relativePath, filepath string) IRoutes Static(relativePath, root string) IRoutes StaticFS(relativePath string, fs http." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/SCA/docs/gin-gonic_gin/0201_router/" /><meta property="article:section" content="docs" />

<meta property="article:modified_time" content="2022-02-04T11:38:06+08:00" />

<title>0201 Router | SourceCodeAnalysis</title>
<link rel="manifest" href="/SCA/manifest.json">
<link rel="icon" href="/SCA/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/SCA/book.min.97cfda4f5e3c9fa49a2bf8d401f4ddc0eec576c99cdcf6afbec19173200c37db.css" >
  <script defer src="/SCA/flexsearch.min.js"></script>
  <script defer src="/SCA/en.search.min.57f9b31c7ca1ae1f1ead74b1a88c6bf44bb5707361ffe5cf148fd14fbd82a525.js" ></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/SCA/"><span>SourceCodeAnalysis</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-068369a7839e687a60defc326c6ae3b1" class="toggle" checked />
    <label for="section-068369a7839e687a60defc326c6ae3b1" class="flex justify-between">
      <a role="button" class="">gin-gonic/gin</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/gin-gonic_gin/0001_preface/" class="">0001 Preface</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/gin-gonic_gin/0101_flow/" class="">0101 Flow</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/gin-gonic_gin/0200/" class="">200th</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/gin-gonic_gin/0201_router/" class=" active">0201 Router</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/gin-gonic_gin/0202_radix_tree/" class="">0202 Radix Tree</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/gin-gonic_gin/0301_request/" class="">0301 Request</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/gin-gonic_gin/0401_response/" class="">0401 Response</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/gin-gonic_gin/0501_other/" class="">0501 Other</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6e8bbf282ebf66cf249a9e198c334299" class="toggle"  />
    <label for="section-6e8bbf282ebf66cf249a9e198c334299" class="flex justify-between">
      <a role="button" class="">tal-tech/go-zero</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2ca4f21c93ca8ec9f0714b747485f1a5" class="toggle"  />
    <label for="section-2ca4f21c93ca8ec9f0714b747485f1a5" class="flex justify-between">
      <a role="button" class="">Core</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/tal-tech_go-zero/core/01_bloom_filter/" class="">01 Bloom Filter</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/tal-tech_go-zero/core/02_break/" class="">02 Break</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/tal-tech_go-zero/core/03_collection/" class="">03 Collection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/tal-tech_go-zero/core/04_executor/" class="">04 Executor</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/tal-tech_go-zero/core/05_fx/" class="">05 Fx</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/tal-tech_go-zero/core/06_hash/" class="">06 Hash</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/SCA/docs/tal-tech_go-zero/core/09_other/" class="">09 Other</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/SCA/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>0201 Router</strong>

  <label for="toc-control">
    
    <img src="/SCA/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#路由api">路由API</a>
          <ul>
            <li><a href="#设置路由">设置路由</a></li>
            <li><a href="#routegroup的获取">RouteGroup的获取</a></li>
            <li><a href="#路由的命中">路由的命中</a></li>
          </ul>
        </li>
        <li><a href="#路由的调用逻辑">路由的调用逻辑</a>
          <ul>
            <li><a href="#背景知识">背景知识</a></li>
            <li><a href="#添加路由">添加路由</a></li>
            <li><a href="#查找路由">查找路由</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><p>路由调用逻辑</p>
<p>gin 对外宣传的高效，很大一部分是说其路由效率。本文内容包括：</p>
<ul>
<li>路由API介绍</li>
<li>路由调用实现逻辑</li>
<li>路由的内部实现</li>
</ul>
<h2 id="路由api">
  路由API
  <a class="anchor" href="#%e8%b7%af%e7%94%b1api">#</a>
</h2>
<h3 id="设置路由">
  设置路由
  <a class="anchor" href="#%e8%ae%be%e7%bd%ae%e8%b7%af%e7%94%b1">#</a>
</h3>
<pre tabindex="0"><code>// routergroup.go:20
type IRoutes interface {
    Use(handlers ...HandlerFunc) IRoutes

    Handle(httpMethod, relativePath string, handlers ...HandlerFunc) IRoutes
    Any(relativePath string, handlers ...HandlerFunc) IRoutes
    GET(relativePath string, handlers ...HandlerFunc) IRoutes
    POST(relativePath string, handlers ...HandlerFunc) IRoutes
    DELETE(relativePath string, handlers ...HandlerFunc) IRoutes
    PATCH(relativePath string, handlers ...HandlerFunc) IRoutes
    PUT(relativePath string, handlers ...HandlerFunc) IRoutes
    OPTIONS(relativePath string, handlers ...HandlerFunc) IRoutes
    HEAD(relativePath string, handlers ...HandlerFunc) IRoutes

    StaticFile(relativePath, filepath string) IRoutes
    Static(relativePath, root string) IRoutes
    StaticFS(relativePath string, fs http.FileSystem) IRoutes
}

// routergroup.go:15
type IRouter interface {
    IRoutes
    Group(string, ...HandlerFunc) *RouterGroup
}
</code></pre><h3 id="routegroup的获取">
  RouteGroup的获取
  <a class="anchor" href="#routegroup%e7%9a%84%e8%8e%b7%e5%8f%96">#</a>
</h3>
<ul>
<li>Engine嵌入了RouteGroup，它本身就实现了IRoutes接口，gin.New() 和 gin.Default() 可以得到Engine对象</li>
<li>Engine.Group(relativePath string, handlers &hellip;HandlerFunc)可以得到一个新的RouteGroup</li>
</ul>
<h3 id="路由的命中">
  路由的命中
  <a class="anchor" href="#%e8%b7%af%e7%94%b1%e7%9a%84%e5%91%bd%e4%b8%ad">#</a>
</h3>
<p>初始化时将 <code>gin.go:handleHTTPRequest</code> 设置为http请求的处理者，它会将请求进行预处理后去处查找命中的处理者（列表），然后去执行。
这个是调用逻辑，我们讲具体实现。</p>
<h2 id="路由的调用逻辑">
  路由的调用逻辑
  <a class="anchor" href="#%e8%b7%af%e7%94%b1%e7%9a%84%e8%b0%83%e7%94%a8%e9%80%bb%e8%be%91">#</a>
</h2>
<h3 id="背景知识">
  背景知识
  <a class="anchor" href="#%e8%83%8c%e6%99%af%e7%9f%a5%e8%af%86">#</a>
</h3>
<p>我们先看 <code>Engine</code> 结构体和路由有关的字段</p>
<pre tabindex="0"><code>gin.go:50

type Engine struct {
    RouterGroup

    // 如果true，当前路由匹配失败但将路径最后的 / 去掉时匹配成功时自动匹配后者
    // 比如：请求是 /foo/ 但没有命中，而存在 /foo，
    // 对get method请求，客户端会被301重定向到 /foo
    // 对于其他method请求，客户端会被307重定向到 /foo
    RedirectTrailingSlash bool

    // 如果true，在没有处理者被注册来处理当前请求时router将尝试修复当前请求路径
    // 逻辑为：
    // - 移除前面的 ../ 或者 //
    // - 对新的路径进行大小写不敏感的查询
    // 如果找到了处理者，请求会被301或307重定向
    // 比如： /FOO 和 /..//FOO 会被重定向到 /foo
    // RedirectTrailingSlash 参数和这个参数独立
    RedirectFixedPath bool

    // 如果true，当路由没有被命中时，去检查是否有其他method命中
    //  如果命中，响应405 （Method Not Allowed）
    //  如果没有命中，请求将由 NotFound handler 来处理
    HandleMethodNotAllowed bool

    // 如果true， url.RawPath 会被用来查找参数
    UseRawPath bool

    // 如果true， path value 会被保留
    // 如果 UseRawPath是false(默认)，UnescapePathValues为true
    // url.Path会被保留并使用
    UnescapePathValues bool

    allNoRoute       HandlersChain
    allNoMethod      HandlersChain
    noRoute          HandlersChain
    noMethod         HandlersChain

    //每个http method对应一棵树
    trees            methodTrees
}

// gin.go:30
type HandlerFunc func(*Context)
type HandlersChain []HandlerFunc

// routergroup.go:40
type RouterGroup struct {
    // 这个路由会参与处理的函数列表
    Handlers HandlersChain
    basePath string
    // 单例存在
    engine   *Engine
    // 是否是根
    root     bool
}

</code></pre><h3 id="添加路由">
  添加路由
  <a class="anchor" href="#%e6%b7%bb%e5%8a%a0%e8%b7%af%e7%94%b1">#</a>
</h3>
<pre tabindex="0"><code>// routergroup.go:70
func (group *RouterGroup) handle(httpMethod, relativePath string, handlers HandlersChain) IRoutes {
    // 将basePath和relativePath加起来得到最终的路径
    absolutePath := group.calculateAbsolutePath(relativePath)
    // 将现有的 Handlers 和 handlers合并起来
    handlers = group.combineHandlers(handlers)
    // 将这个route加入到engine.tree
    group.engine.addRoute(httpMethod, absolutePath, handlers)
    // 返回
    return group.returnObj()
}
</code></pre><p>上面的 <code>addRoute()</code> 的实现：</p>
<pre tabindex="0"><code>func (engine *Engine) addRoute(method, path string, handlers HandlersChain) {
    // 常规检查
    assert1(path[0] == '/', &quot;path must begin with '/'&quot;)
    assert1(method != &quot;&quot;, &quot;HTTP method can not be empty&quot;)
    assert1(len(handlers) &gt; 0, &quot;there must be at least one handler&quot;)
    
    debugPrintRoute(method, path, handlers)
    // 维护engine.trees
    root := engine.trees.get(method)
    if root == nil {
    root = new(node)
    engine.trees = append(engine.trees, methodTree{method: method, root: root})
    }

    // 核心，后面一起来讲
    root.addRoute(path, handlers)
}
</code></pre><h3 id="查找路由">
  查找路由
  <a class="anchor" href="#%e6%9f%a5%e6%89%be%e8%b7%af%e7%94%b1">#</a>
</h3>
<p>我们看看路由查找逻辑：</p>
<pre tabindex="0"><code>gin.go:340

func (engine *Engine) handleHTTPRequest(c *Context) {
    httpMethod := c.Request.Method
    path := c.Request.URL.Path
    unescape := false
    // 看是否使用 RawPath
    if engine.UseRawPath &amp;&amp; len(c.Request.URL.RawPath) &gt; 0 {
        path = c.Request.URL.RawPath
        unescape = engine.UnescapePathValues
    }

    t := engine.trees
    // 根据 http method 得到目标树
    for i, tl := 0, len(t); i &lt; tl; i++ {
        if t[i].method == httpMethod {
            // 目标树找到了，为本次请求路由树的根节点
            root := t[i].root
            // 根据path查找节点
            // 核心，后面来讲
            handlers, params, tsr := root.getValue(path, c.Params, unescape)
            if handlers != nil {
                c.handlers = handlers
                c.Params = params
                c.Next()
                c.writermem.WriteHeaderNow()
                return
            }


            if httpMethod != &quot;CONNECT&quot; &amp;&amp; path != &quot;/&quot; {
                // 如果 trailing slash redirect，就重定向出去
                if tsr &amp;&amp; engine.RedirectTrailingSlash {
                    redirectTrailingSlash(c)
                    return
                }

                // fix path
                if engine.RedirectFixedPath &amp;&amp; redirectFixedPath(c, root, engine.RedirectFixedPath) {
                    return
                }
            }
            // 没找到
            break
        }
    }

    // 如果是因为HTTP method有误，回复这个
    if engine.HandleMethodNotAllowed {
        for _, tree := range engine.trees {
            if tree.method != httpMethod {
                if handlers, _, _ := tree.root.getValue(path, nil, unescape); handlers != nil {
                    c.handlers = engine.allNoMethod
                    serveError(c, 405, default405Body)
                    return
                }
            }
        }
    }

    // 交给 NotRoute （404）
    c.handlers = engine.allNoRoute
    serveError(c, 404, default404Body)
}
</code></pre></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://githbu.com/liuximu/sca/commit/879fc794306f3f6e1e7326fc6a9d668f203e32c5" title='Last modified by liuximu | February 4, 2022' target="_blank" rel="noopener">
      <img src="/SCA/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>February 4, 2022</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://githbu.com/liuximu/sca/edit/master/content/docs/gin-gonic_gin/0201_router.md" target="_blank" rel="noopener">
      <img src="/SCA/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>


</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#路由api">路由API</a>
          <ul>
            <li><a href="#设置路由">设置路由</a></li>
            <li><a href="#routegroup的获取">RouteGroup的获取</a></li>
            <li><a href="#路由的命中">路由的命中</a></li>
          </ul>
        </li>
        <li><a href="#路由的调用逻辑">路由的调用逻辑</a>
          <ul>
            <li><a href="#背景知识">背景知识</a></li>
            <li><a href="#添加路由">添加路由</a></li>
            <li><a href="#查找路由">查找路由</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












